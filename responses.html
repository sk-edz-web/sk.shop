<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>skedz · messages</title>
  <!-- Font & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,300;14..32,400;14..32,600;14..32,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="icon" href="logo.jpg" type="image/png">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    /* === RESET + GLOBAL (same theme) === */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: #f4f7fc;
      background: radial-gradient(circle at 10% 30%, #e9eff7, #dbe5f0);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: #1b2b40;
      line-height: 1.4;
    }
    .app {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1.2rem 1.8rem;
      width: 100%;
      flex: 1;
    }
    /* ===== DESKTOP HEADER ===== */
    .desktop-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 0 2rem 0;
      flex-wrap: wrap;
    }
    .logo-area {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
    }
    .logo-icon {
      font-size: 2.2rem;
      color: #1e3c5c;
      filter: drop-shadow(0 6px 10px rgba(22, 78, 161, 0.15));
      animation: softGlow 3s infinite alternate;
    }
    @keyframes softGlow {
      0% { filter: drop-shadow(0 4px 8px rgba(0,60,130,0.2)); }
      100% { filter: drop-shadow(0 12px 18px rgba(0,90,200,0.35)); }
    }
    .logo-text {
      font-weight: 700;
      font-size: 1.8rem;
      letter-spacing: -0.02em;
      background: linear-gradient(145deg, #13293D, #1F4E79);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
    }
    .desktop-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .desktop-actions .action-btn {
      background: rgba(255,255,255,0.5);
      backdrop-filter: blur(4px);
      padding: 0.6rem 1.2rem;
      border-radius: 60px;
      font-weight: 500;
      font-size: 0.95rem;
      color: #13293D;
      border: 1px solid rgba(255,255,255,0.7);
      transition: 0.2s;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    .desktop-actions .action-btn i { margin-right: 6px; color: #2c5779; }
    .desktop-actions .action-btn:hover {
      background: white;
      border-color: #a0c6e9;
      transform: scale(1.02);
    }
    /* ----- MOBILE NAVIGATION ----- */
    .mobile-nav { display: none; }
    /* ===== RESPONSES PAGE SPECIFIC ===== */
    .responses-hero {
      margin: 1rem 0 2rem 0;
    }
    .responses-hero .badge {
      background: rgba(43, 108, 176, 0.18);
      backdrop-filter: blur(3px);
      display: inline-block;
      padding: 0.4rem 1.1rem;
      border-radius: 40px;
      font-size: 0.8rem;
      font-weight: 600;
      color: #1e4f7a;
      border: 1px solid rgba(255,255,255,0.5);
      margin-bottom: 1.2rem;
    }
    .responses-hero h1 {
      font-size: clamp(2.4rem, 7vw, 3.8rem);
      font-weight: 700;
      line-height: 1.1;
      background: linear-gradient(155deg, #102b40, #264e70, #1b3b55);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
      margin-bottom: 0.5rem;
    }
    .responses-hero p {
      font-size: 1.1rem;
      color: #2f4055;
      font-weight: 300;
    }
    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }
    .stat-card {
      background: rgba(255,255,255,0.3);
      backdrop-filter: blur(8px);
      border-radius: 36px;
      padding: 1.5rem;
      border: 1px solid rgba(255,255,255,0.7);
      text-align: center;
    }
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: #1e5a88;
    }
    .stat-label {
      color: #2f5579;
      font-weight: 500;
    }
    /* Messages Container */
    .messages-container {
      background: rgba(255,255,255,0.25);
      backdrop-filter: blur(8px);
      border-radius: 48px;
      padding: 2rem;
      border: 1px solid rgba(255,255,255,0.7);
      margin: 2rem 0;
    }
    .messages-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .messages-header h2 {
      font-size: 1.8rem;
      color: #102b40;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .filter-buttons {
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
    }
    .filter-btn {
      background: rgba(255,255,255,0.5);
      border: 1px solid white;
      padding: 0.6rem 1.2rem;
      border-radius: 60px;
      font-weight: 500;
      cursor: pointer;
      transition: 0.15s;
      font-size: 0.9rem;
    }
    .filter-btn.active {
      background: #1e5a88;
      color: white;
      border-color: #1e5a88;
    }
    .filter-btn:hover {
      background: white;
    }
    /* Message Cards */
    .message-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
    }
    .message-card {
      background: rgba(255,255,255,0.3);
      backdrop-filter: blur(8px);
      border-radius: 36px;
      padding: 1.5rem;
      border: 1px solid rgba(255,255,255,0.7);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    .message-card:hover {
      transform: translateY(-4px);
      background: rgba(255,255,255,0.5);
      box-shadow: 0 20px 30px -12px #1b4c79;
    }
    .message-card.unread {
      border-left: 5px solid #1e5a88;
    }
    .message-card.read {
      opacity: 0.8;
    }
    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }
    .message-sender {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }
    .sender-avatar {
      width: 48px;
      height: 48px;
      background: rgba(43, 98, 142, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1e5a88;
      font-size: 1.5rem;
      border: 1px solid white;
    }
    .sender-info h4 {
      font-size: 1.2rem;
      font-weight: 600;
      color: #13293D;
      margin-bottom: 0.2rem;
    }
    .sender-info p {
      font-size: 0.85rem;
      color: #2f5579;
    }
    .message-status {
      display: flex;
      gap: 0.5rem;
    }
    .status-badge {
      padding: 0.3rem 0.8rem;
      border-radius: 40px;
      font-size: 0.75rem;
      font-weight: 600;
      background: rgba(255,255,255,0.5);
    }
    .status-badge.new {
      background: #1e5a88;
      color: white;
    }
    .status-badge.replied {
      background: #25D366;
      color: white;
    }
    .message-subject {
      font-size: 1.1rem;
      font-weight: 600;
      color: #102b40;
      margin: 1rem 0 0.5rem;
    }
    .message-preview {
      color: #2f5579;
      font-size: 0.95rem;
      line-height: 1.5;
      margin-bottom: 1rem;
      display: -webkit-box;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .message-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.3);
    }
    .message-time {
      font-size: 0.85rem;
      color: #4a6f94;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .message-actions {
      display: flex;
      gap: 0.5rem;
      position: relative;
      z-index: 10;
    }
    .icon-btn {
      background: rgba(255,255,255,0.5);
      border: 1px solid white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.15s;
      color: #1e5a88;
    }
    .icon-btn:hover {
      background: white;
      transform: scale(1.05);
    }
    .icon-btn.delete:hover {
      color: #c13b6f;
    }
    /* Full Message Modal */
    .message-modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(12px);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0; visibility: hidden;
      transition: 0.25s ease;
    }
    .message-modal-overlay.active { opacity: 1; visibility: visible; }
    .message-modal-content {
      background: rgba(255,255,255,0.75);
      backdrop-filter: blur(20px);
      width: 90%; max-width: 600px;
      max-height: 85vh;
      overflow-y: auto;
      border-radius: 60px;
      padding: 2rem;
      border: 1px solid white;
      box-shadow: 0 40px 60px -20px #0a2a41;
      transform: scale(0.95);
      transition: 0.3s;
    }
    .message-modal-overlay.active .message-modal-content { transform: scale(1); }
    .modal-close {
      float: right;
      font-size: 1.8rem;
      background: none;
      border: none;
      color: #1f4e79;
      cursor: pointer;
      width: 40px; height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.5);
    }
    .modal-close:hover { background: white; }
    .full-message {
      margin: 1.5rem 0;
      line-height: 1.8;
      color: #2f5579;
      white-space: pre-wrap;
    }
    .reply-section {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid rgba(255,255,255,0.3);
    }
    .reply-input {
      width: 100%;
      padding: 1rem;
      background: rgba(255,255,255,0.6);
      border: 1px solid white;
      border-radius: 60px;
      font-size: 1rem;
      outline: none;
      margin-bottom: 1rem;
    }
    .reply-input:focus {
      background: white;
    }
    .send-reply-btn {
      background: #1e5a88;
      color: white;
      border: none;
      padding: 0.8rem 2rem;
      border-radius: 60px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
      border: 1px solid rgba(255,255,255,0.4);
    }
    .send-reply-btn:hover {
      background: #13293D;
      transform: scale(1.02);
    }
    /* Delete Confirmation Popup */
    .confirm-popup-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(8px);
      z-index: 3000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0; visibility: hidden;
      transition: 0.2s;
    }
    .confirm-popup-overlay.active { opacity: 1; visibility: visible; }
    .confirm-popup {
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(20px);
      width: 90%; max-width: 350px;
      border-radius: 48px;
      padding: 2rem;
      border: 1px solid white;
      box-shadow: 0 30px 50px -20px #0a2a41;
      text-align: center;
      transform: scale(0.9);
      transition: 0.2s;
    }
    .confirm-popup-overlay.active .confirm-popup { transform: scale(1); }
    .confirm-popup i {
      font-size: 3rem;
      color: #c13b6f;
      margin-bottom: 1rem;
    }
    .confirm-popup h3 {
      font-size: 1.5rem;
      color: #102b40;
      margin-bottom: 0.5rem;
    }
    .confirm-popup p {
      color: #2f5579;
      margin-bottom: 1.5rem;
    }
    .confirm-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }
    .confirm-btn {
      padding: 0.8rem 1.8rem;
      border-radius: 60px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.15s;
      border: 1px solid white;
    }
    .confirm-btn.cancel {
      background: rgba(255,255,255,0.5);
      color: #1d4e75;
    }
    .confirm-btn.delete {
      background: #c13b6f;
      color: white;
    }
    .confirm-btn:hover {
      transform: scale(1.02);
    }
    .toast-message {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30, 90, 136, 0.9);
      backdrop-filter: blur(10px);
      color: white;
      padding: 1rem 2rem;
      border-radius: 60px;
      font-weight: 500;
      z-index: 4000;
      border: 1px solid rgba(255,255,255,0.3);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      display: none;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { transform: translate(-50%, 20px); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }
    /* --- Primary Button --- */
.btn-primary {
  background: rgba(43, 98, 142, 0.85);
  color: white;
  border: none;
  padding: 1rem 2rem;
  border-radius: 60px;
  font-weight: 600;
  font-size: 1.1rem;
  cursor: pointer;
  transition: 0.2s;
  border: 1px solid rgba(255, 255, 255, 0.4);
  display: inline-flex;
  align-items: center;
  gap: 8px; /* Spaces the icon from the text */
}
.btn-primary:hover {
  background: #1e5a88;
  transform: scale(1.02);
}

/* --- Secondary Button --- */
.btn-secondary {
  background: rgba(255, 255, 255, 0.5);
  color: #13293D;
  border: 1px solid white;
  padding: 0.8rem 1.5rem;
  border-radius: 60px;
  font-weight: 500;
  cursor: pointer;
  transition: 0.15s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  text-decoration: none; /* In case you use it on an <a> tag */
}
.btn-secondary:hover {
  background: white;
}

/* --- Small Action Button --- */
.action-btn {
  background: rgba(255, 255, 255, 0.5);
  border: 1px solid white;
  padding: 0.4rem 1rem;
  border-radius: 40px;
  cursor: pointer;
  transition: 0.15s;
  margin-right: 0.5rem;
  color: #13293D;
}
.action-btn:hover {
  background: white;
}
.action-btn.delete {
  color: #c13b6f; /* Red color for delete actions */
}
    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #1e5a88;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-container {
      grid-column: 1 / -1;
      text-align: center;
      padding: 4rem;
      color: #1e5a88;
    }
    .empty-state {
      text-align: center;
      padding: 4rem;
      color: #2f5579;
    }
    .empty-state i {
      font-size: 4rem;
      color: #1e5a88;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    /* Footer */
    .footer-note {
      margin-top: 4rem;
      padding: 1.8rem 0.5rem;
      text-align: center;
      border-top: 1px solid rgba(255,255,255,0.6);
      font-weight: 300;
      color: #2e5375;
    }
    /* Mobile styles */
    @media screen and (max-width: 768px) {
      .app { padding: 0.8rem 1.2rem; }
      .desktop-actions { display: none; }
      .mobile-nav {
        display: flex;
        position: fixed;
        bottom: 16px;
        left: 12px;
        right: 12px;
        background: rgba(30, 50, 75, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 60px;
        padding: 0.8rem 1.2rem;
        justify-content: space-around;
        z-index: 9999;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.2);
      }
      .mobile-nav a {
        color: rgba(255,255,255,0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 0.85rem;
        text-decoration: none;
        padding: 0.3rem;
        -webkit-tap-highlight-color: transparent;
      }
      .mobile-nav a i { font-size: 1.5rem; }
      .mobile-nav a:active { transform: scale(0.95); }
      body { padding-bottom: 85px; }
      .message-grid {
        grid-template-columns: 1fr;
      }
      .messages-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .toast-message {
        bottom: 100px;
        width: 90%;
        text-align: center;
      }
    }
    @media screen and (min-width: 769px) {
      .mobile-nav { display: none !important; }
      body { padding-bottom: 0; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- DESKTOP HEADER - Updated to lumina -->
    <header class="desktop-header">
      <div class="logo-area" onclick="window.location.href='index.html'">
        <i class="fas fa-bolt logo-icon"></i>
        <span class="logo-text">SK EDZ<span style="font-weight:300; color:#2f638f;">/messages</span></span>
      </div>

      <a href="admin.html" class="btn-secondary">
  <i class="fas fa-user-shield"></i> Admin Panel
</a>
    </header>

    <!-- HERO SECTION -->
    <section class="responses-hero">
      <span class="badge"><i class="fas fa-inbox"></i> contact form submissions</span>
      <h1>messages</h1>
      <p>View and manage all messages from contact.html</p>
    </section>

    <!-- STATS CARDS -->
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-number" id="totalMessages">0</div>
        <div class="stat-label">total messages</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="unreadMessages">0</div>
        <div class="stat-label">unread</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="repliedMessages">0</div>
        <div class="stat-label">replied</div>
      </div>
    </div>

    <!-- MESSAGES CONTAINER -->
    <div class="messages-container">
      <div class="messages-header">
        <h2><i class="fas fa-comments"></i> all messages</h2>
        <div class="filter-buttons">
          <button class="filter-btn active" data-filter="all">all</button>
          <button class="filter-btn" data-filter="unread">unread</button>
          <button class="filter-btn" data-filter="read">read</button>
          <button class="filter-btn" data-filter="replied">replied</button>
        </div>
      </div>

      <!-- MESSAGE GRID -->
      <div class="message-grid" id="messageGrid">
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p style="margin-top: 1.5rem;">Loading messages...</p>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <div class="footer-note">
      <i class="fas fa-circle-check" style="color: #2d6f9e;"></i> responses.html · messages from contact form
    </div>
  </div>

  <!-- FULL MESSAGE MODAL -->
  <div class="message-modal-overlay" id="messageModal">
    <div class="message-modal-content">
      <button class="modal-close" id="closeMessageModal"><i class="fas fa-times"></i></button>
      <div id="fullMessageContent"></div>
    </div>
  </div>

  <!-- DELETE CONFIRMATION POPUP (In-app, not browser) -->
  <div class="confirm-popup-overlay" id="confirmPopup">
    <div class="confirm-popup">
      <i class="fas fa-exclamation-triangle"></i>
      <h3>Delete Message</h3>
      <p>Are you sure you want to delete this message? This action cannot be undone.</p>
      <div class="confirm-actions">
        <button class="confirm-btn cancel" id="cancelDeleteBtn">Cancel</button>
        <button class="confirm-btn delete" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <!-- TOAST MESSAGE -->
  <div class="toast-message" id="toastMessage"></div>

  <script>
    (function() {
      // ========== FIREBASE CONFIG ==========
      const firebaseConfig = {
        apiKey: "AIzaSyBxc6D8eZyDgRhClZXeaYJuzvruy7S-nrI",
        authDomain: "sk-shop-admin.firebaseapp.com",
        databaseURL: "https://sk-shop-admin-default-rtdb.firebaseio.com",
        projectId: "sk-shop-admin",
        storageBucket: "sk-shop-admin.firebasestorage.app",
        messagingSenderId: "269505526934",
        appId: "1:269505526934:web:35c68fe963961703e8d6b7",
        measurementId: "G-FH3CMFTZVQ"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      const messagesRef = database.ref('messages');

      // State
      let allMessages = [];
      let currentFilter = 'all';
      let currentMessage = null;
      let messageToDelete = null;

      // DOM Elements
      const messageGrid = document.getElementById('messageGrid');
      const totalMessagesEl = document.getElementById('totalMessages');
      const unreadMessagesEl = document.getElementById('unreadMessages');
      const repliedMessagesEl = document.getElementById('repliedMessages');
      const filterBtns = document.querySelectorAll('.filter-btn');
      const messageModal = document.getElementById('messageModal');
      const closeMessageModal = document.getElementById('closeMessageModal');
      const fullMessageContent = document.getElementById('fullMessageContent');
      
      // Delete confirmation popup elements
      const confirmPopup = document.getElementById('confirmPopup');
      const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
      const toastMessage = document.getElementById('toastMessage');

      // Show toast message
      function showToast(text, isSuccess = true) {
        toastMessage.style.display = 'block';
        toastMessage.style.background = isSuccess ? 'rgba(30, 90, 136, 0.9)' : 'rgba(193, 59, 111, 0.9)';
        toastMessage.textContent = text;
        
        setTimeout(() => {
          toastMessage.style.display = 'none';
        }, 3000);
      }

      // Format timestamp
      function formatTimestamp(timestamp) {
        if (!timestamp) return 'Unknown';
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        
        if (days === 0) {
          return 'Today at ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else if (days === 1) {
          return 'Yesterday at ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else if (days < 7) {
          return days + ' days ago';
        } else {
          return date.toLocaleDateString();
        }
      }

      // Update stats
      function updateStats() {
        const total = allMessages.length;
        const unread = allMessages.filter(m => !m.read).length;
        const replied = allMessages.filter(m => m.replied).length;

        totalMessagesEl.textContent = total;
        unreadMessagesEl.textContent = unread;
        repliedMessagesEl.textContent = replied;
      }

      // Filter messages
      function filterMessages(messages, filter) {
        switch(filter) {
          case 'unread':
            return messages.filter(m => !m.read);
          case 'read':
            return messages.filter(m => m.read && !m.replied);
          case 'replied':
            return messages.filter(m => m.replied);
          default:
            return messages;
        }
      }

      // Mark as read
      function markAsRead(messageId) {
        messagesRef.child(messageId).update({ read: true });
      }

      // Mark as replied
      function markAsReplied(messageId) {
        messagesRef.child(messageId).update({ replied: true, read: true });
      }

      // Show delete confirmation popup
      function showDeleteConfirmation(messageId, event) {
        if (event) {
          event.stopPropagation(); // Prevent card click
        }
        
        messageToDelete = messageId;
        confirmPopup.classList.add('active');
      }

      // Execute delete
      function executeDelete() {
        if (!messageToDelete) return;
        
        messagesRef.child(messageToDelete).remove()
          .then(() => {
            confirmPopup.classList.remove('active');
            showToast('✅ Message deleted successfully', true);
            messageToDelete = null;
            
            // Close modal if open and deleted message is current
            if (currentMessage && currentMessage.id === messageToDelete) {
              messageModal.classList.remove('active');
            }
          })
          .catch(error => {
            console.error('Error deleting message:', error);
            showToast('❌ Error deleting message: ' + error.message, false);
            confirmPopup.classList.remove('active');
          });
      }

      // Open full message
      function openFullMessage(message) {
        currentMessage = message;
        markAsRead(message.id);
        
        fullMessageContent.innerHTML = `
          <div style="margin-top: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
              <div class="sender-avatar" style="width: 60px; height: 60px; font-size: 2rem;">
                <i class="fas fa-user"></i>
              </div>
              <div>
                <h3 style="font-size: 1.5rem; color: #13293D;">${message.name || 'Unknown'}</h3>
                <p style="color: #1e5a88;">${message.email || 'No email'}</p>
                <p style="color: #2f5579; font-size: 0.9rem;">${formatTimestamp(message.timestamp)}</p>
              </div>
            </div>
            <div style="background: rgba(255,255,255,0.3); padding: 1.5rem; border-radius: 36px; margin: 1rem 0;">
              <h4 style="color: #102b40; margin-bottom: 0.5rem;">Subject: ${message.subject || 'No subject'}</h4>
              <div class="full-message">${message.message || 'No message content'}</div>
            </div>
            ${!message.replied ? `
              <div class="reply-section">
                <h4 style="color: #102b40; margin-bottom: 1rem;">Reply to this message:</h4>
                <textarea id="replyText" class="reply-input" rows="3" placeholder="Type your reply..."></textarea>
                <button class="send-reply-btn" id="sendReplyBtn"><i class="fas fa-paper-plane"></i> Send Reply</button>
              </div>
            ` : `
              <div style="background: rgba(30, 90, 136, 0.1); padding: 1rem; border-radius: 36px; text-align: center; color: #1e5a88;">
                <i class="fas fa-check-circle"></i> Reply sent
              </div>
            `}
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
              <button class="icon-btn delete" id="modalDeleteBtn" style="color: #c13b6f;"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        `;

        messageModal.classList.add('active');

        // Add delete handler in modal
        document.getElementById('modalDeleteBtn')?.addEventListener('click', (e) => {
          e.stopPropagation();
          showDeleteConfirmation(message.id, e);
        });

        // Add reply handler if not replied
        if (!message.replied) {
          document.getElementById('sendReplyBtn')?.addEventListener('click', () => {
            const reply = document.getElementById('replyText').value.trim();
            if (!reply) {
              showToast('Please type a reply', false);
              return;
            }

            showToast('✅ Reply sent to ' + message.email, true);
            
            // Mark as replied
            markAsReplied(message.id);
            messageModal.classList.remove('active');
          });
        }
      }

      // Render messages
      function renderMessages() {
        if (!allMessages.length) {
          messageGrid.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-inbox"></i>
              <h3>No messages yet</h3>
              <p>Messages from contact.html will appear here</p>
            </div>
          `;
          return;
        }

        const filteredMessages = filterMessages(allMessages, currentFilter);
        
        if (!filteredMessages.length) {
          messageGrid.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-filter"></i>
              <h3>No ${currentFilter} messages</h3>
            </div>
          `;
          return;
        }

        let html = '';
        filteredMessages.forEach(msg => {
          const isUnread = !msg.read;
          
          html += `
            <div class="message-card ${isUnread ? 'unread' : ''}" data-id="${msg.id}">
              <div class="message-header">
                <div class="message-sender">
                  <div class="sender-avatar">
                    <i class="fas fa-user"></i>
                  </div>
                  <div class="sender-info">
                    <h4>${msg.name || 'Unknown'}</h4>
                    <p>${msg.email || 'No email'}</p>
                  </div>
                </div>
                <div class="message-status">
                  ${!msg.read ? '<span class="status-badge new">new</span>' : ''}
                  ${msg.replied ? '<span class="status-badge replied">replied</span>' : ''}
                </div>
              </div>
              <div class="message-subject">${msg.subject || 'No subject'}</div>
              <div class="message-preview">${msg.message || 'No message'}</div>
              <div class="message-footer">
                <div class="message-time">
                  <i class="far fa-clock"></i> ${formatTimestamp(msg.timestamp)}
                </div>
                <div class="message-actions" onclick="event.stopPropagation()">
                  <button class="icon-btn view-btn" data-id="${msg.id}" title="View full message"><i class="fas fa-eye"></i></button>
                  <button class="icon-btn delete" data-id="${msg.id}" title="Delete message"><i class="fas fa-trash"></i></button>
                </div>
              </div>
            </div>
          `;
        });

        messageGrid.innerHTML = html;

        // Attach event listeners
        document.querySelectorAll('.message-card').forEach(card => {
          const id = card.dataset.id;
          const message = allMessages.find(m => m.id === id);

          // Card click
          card.addEventListener('click', (e) => {
            if (!e.target.closest('.icon-btn')) {
              openFullMessage(message);
            }
          });
        });

        // View button clicks
        document.querySelectorAll('.view-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = btn.dataset.id;
            const message = allMessages.find(m => m.id === id);
            if (message) openFullMessage(message);
          });
        });

        // Delete button clicks - Show in-app popup
        document.querySelectorAll('.delete').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = btn.dataset.id;
            showDeleteConfirmation(id, e);
          });
        });
      }

      // Load messages from Firebase
      function loadMessages() {
        messagesRef.on('value', (snapshot) => {
          const messages = snapshot.val();
          
          if (messages) {
            allMessages = Object.keys(messages).map(key => ({
              id: key,
              ...messages[key],
              read: messages[key].read || false,
              replied: messages[key].replied || false
            })).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
          } else {
            allMessages = [];
          }

          updateStats();
          renderMessages();
        }, (error) => {
          console.error('Firebase error:', error);
          messageGrid.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Error loading messages</h3>
              <p>${error.message}</p>
            </div>
          `;
        });
      }

      // Filter buttons
      filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          filterBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.filter;
          renderMessages();
        });
      });

      // Close modal
      closeMessageModal.addEventListener('click', () => {
        messageModal.classList.remove('active');
      });

      messageModal.addEventListener('click', (e) => {
        if (e.target === messageModal) {
          messageModal.classList.remove('active');
        }
      });

      // Delete confirmation popup handlers
      cancelDeleteBtn.addEventListener('click', () => {
        confirmPopup.classList.remove('active');
        messageToDelete = null;
      });

      confirmDeleteBtn.addEventListener('click', () => {
        executeDelete();
      });

      // Close popup when clicking outside
      confirmPopup.addEventListener('click', (e) => {
        if (e.target === confirmPopup) {
          confirmPopup.classList.remove('active');
          messageToDelete = null;
        }
      });

      // Initialize
      loadMessages();

      // Mobile navigation fix
      document.querySelectorAll('.mobile-nav a').forEach(link => {
        link.addEventListener('click', function(e) {
          // Let browser handle navigation naturally
          return true;
        });
      });
    })();
  </script>
</body>
</html
